box: python:3.6.4-stretch
build:
  steps:
    - script:
        name: remove python3 symlinks
        code: |
          cd /usr/local/bin
          rm -f idle
          rm -f pydoc
          rm -f python
          rm -f python-config
    - install-packages:
      packages: git cmake g++ python libfontconfig1-dev libx11-dev libxcomposite-dev libgl1-mesa-dev libglu1-mesa-dev freeglut3-dev
    - script:
        name: setup git submodule
        code: |
          git submodule update --init --recursive
    - script:
        name: build externals
        code: |
          cd externals/libemoji
          cmake .
          make
    - script:
        name: install dependencies
        code: |
          python3 -m pip install -r requirements-dev.txt
    - script:
        name: build
        code: |
          python3 setup.py build
          gcc -pthread -shared build/temp.linux-x86_64-3.6/src/emoji.o build/lib.linux-x86_64-3.6/emoji.cpython-36m-x86_64-linux-gnu.so -Llib -L/usr/local/lib -lskia -lemoji -ldl -lfontconfig -lfreetype -lGL -lGLU -lpython3.6m
          cp build/lib.linux-x86_64-3.6/emoji.cpython-36m-x86_64-linux-gnu.so .
    - script:
        name: test
        code: |
          python3 -m pytest test
    - script:
        name: output dummy file
        code: |
          touch $WERCKER_OUTPUT_DIR/dummy
  after-steps:
    - install-packages:
        packages: ruby
    - wantedly/pretty-slack-notify:
        webhook_url: $SLACK_WEBHOOK_URL
        channel: emoji

